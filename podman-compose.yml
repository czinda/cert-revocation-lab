version: "3.8"

# Certificate Revocation Lab - Full Stack Deployment
# PKI Hierarchy: Root CA -> Intermediate CA -> FreeIPA Sub-CA + IoT Sub-CA

services:
  # ===========================================================================
  # 389 Directory Server Instances (LDAP backend for each Dogtag CA)
  # ===========================================================================

  ds-root:
    image: quay.io/389ds/dirsrv:${DS_VERSION:-latest}
    container_name: ds-root
    hostname: ds-root.${LAB_DOMAIN:-cert-lab.local}
    environment:
      DS_DM_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      DS_SUFFIX_NAME: root-ca
    volumes:
      - ds-root-data:/data
    networks:
      lab-network:
        ipv4_address: ${IP_DS_ROOT:-172.20.0.14}
    healthcheck:
      test: ["CMD-SHELL", "/usr/libexec/dirsrv/dscontainer -H || ldapsearch -x -H ldap://localhost:3389 -b '' -s base > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  ds-intermediate:
    image: quay.io/389ds/dirsrv:${DS_VERSION:-latest}
    container_name: ds-intermediate
    hostname: ds-intermediate.${LAB_DOMAIN:-cert-lab.local}
    environment:
      DS_DM_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      DS_SUFFIX_NAME: intermediate-ca
    volumes:
      - ds-intermediate-data:/data
    networks:
      lab-network:
        ipv4_address: ${IP_DS_INTERMEDIATE:-172.20.0.15}
    healthcheck:
      test: ["CMD-SHELL", "/usr/libexec/dirsrv/dscontainer -H || ldapsearch -x -H ldap://localhost:3389 -b '' -s base > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  ds-iot:
    image: quay.io/389ds/dirsrv:${DS_VERSION:-latest}
    container_name: ds-iot
    hostname: ds-iot.${LAB_DOMAIN:-cert-lab.local}
    environment:
      DS_DM_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      DS_SUFFIX_NAME: iot-ca
    volumes:
      - ds-iot-data:/data
    networks:
      lab-network:
        ipv4_address: ${IP_DS_IOT:-172.20.0.16}
    healthcheck:
      test: ["CMD-SHELL", "/usr/libexec/dirsrv/dscontainer -H || ldapsearch -x -H ldap://localhost:3389 -b '' -s base > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ===========================================================================
  # Dogtag PKI Certificate Authorities
  # ===========================================================================

  dogtag-root-ca:
    image: quay.io/dogtagpki/pki-ca:${PKI_VERSION:-latest}
    container_name: dogtag-root-ca
    hostname: root-ca.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      ds-root:
        condition: service_healthy
    environment:
      PKI_DS_URL: ldap://ds-root.${LAB_DOMAIN:-cert-lab.local}:3389
      PKI_DS_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      PKI_ADMIN_PASSWORD: ${PKI_ADMIN_PASSWORD:?PKI_ADMIN_PASSWORD required}
      PKI_INSTANCE_NAME: pki-root-ca
    volumes:
      - ./configs/pki:/etc/pki-configs:ro
      - ./scripts/pki:/scripts:ro
      - ./data/certs:/certs
      - pki-root-data:/var/lib/pki
      - pki-root-logs:/var/log/pki
    networks:
      lab-network:
        ipv4_address: ${IP_ROOT_CA:-172.20.0.12}
    ports:
      - "8443:8443"
      - "8480:8080"
    command: ["/bin/bash", "-c", "sleep infinity"]

  dogtag-intermediate-ca:
    image: quay.io/dogtagpki/pki-ca:${PKI_VERSION:-latest}
    container_name: dogtag-intermediate-ca
    hostname: intermediate-ca.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      ds-intermediate:
        condition: service_healthy
      dogtag-root-ca:
        condition: service_started
    environment:
      PKI_DS_URL: ldap://ds-intermediate.${LAB_DOMAIN:-cert-lab.local}:3389
      PKI_DS_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      PKI_ADMIN_PASSWORD: ${PKI_ADMIN_PASSWORD:?PKI_ADMIN_PASSWORD required}
      PKI_INSTANCE_NAME: pki-intermediate-ca
    volumes:
      - ./configs/pki:/etc/pki-configs:ro
      - ./scripts/pki:/scripts:ro
      - ./data/certs:/certs
      - pki-intermediate-data:/var/lib/pki
      - pki-intermediate-logs:/var/log/pki
    networks:
      lab-network:
        ipv4_address: ${IP_INTERMEDIATE_CA:-172.20.0.11}
    ports:
      - "8444:8443"
      - "8481:8080"
    command: ["/bin/bash", "-c", "sleep infinity"]

  dogtag-iot-ca:
    image: quay.io/dogtagpki/pki-ca:${PKI_VERSION:-latest}
    container_name: dogtag-iot-ca
    hostname: iot-ca.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      ds-iot:
        condition: service_healthy
      dogtag-intermediate-ca:
        condition: service_started
    environment:
      PKI_DS_URL: ldap://ds-iot.${LAB_DOMAIN:-cert-lab.local}:3389
      PKI_DS_PASSWORD: ${DS_PASSWORD:?DS_PASSWORD required}
      PKI_ADMIN_PASSWORD: ${PKI_ADMIN_PASSWORD:?PKI_ADMIN_PASSWORD required}
      PKI_INSTANCE_NAME: pki-iot-ca
    volumes:
      - ./configs/pki:/etc/pki-configs:ro
      - ./scripts/pki:/scripts:ro
      - ./data/certs:/certs
      - pki-iot-data:/var/lib/pki
      - pki-iot-logs:/var/log/pki
    networks:
      lab-network:
        ipv4_address: ${IP_IOT_CA:-172.20.0.13}
    ports:
      - "8445:8443"
      - "8482:8080"
    command: ["/bin/bash", "-c", "sleep infinity"]

  # ===========================================================================
  # FreeIPA Identity Management (Subordinate to Intermediate CA)
  # ===========================================================================

  # FreeIPA with External CA - requires two-phase initialization
  # Phase 1: Generate CSR with --external-ca
  # Phase 2: Complete install with signed certificate
  # Run: podman exec -it freeipa /scripts/init-freeipa.sh
  freeipa:
    image: quay.io/freeipa/freeipa-server:${IPA_VERSION:-fedora-43}
    container_name: freeipa
    hostname: ipa.${LAB_DOMAIN:-cert-lab.local}
    read_only: false
    privileged: true
    cap_add:
      - SYS_TIME
      - NET_ADMIN
      - SYS_ADMIN
    security_opt:
      - "seccomp:unconfined"
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    tmpfs:
      - /run
      - /tmp
    environment:
      IPA_SERVER_HOSTNAME: ipa.${LAB_DOMAIN:-cert-lab.local}
      IPA_SERVER_IP: ${IP_FREEIPA:-172.20.0.10}
      PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD required}
      container: podman
    volumes:
      - freeipa-data:/data
      - ./data/certs:/certs
      - ./configs/freeipa:/config:ro
      - ./scripts/pki:/scripts:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    depends_on:
      dogtag-intermediate-ca:
        condition: service_started
    networks:
      lab-network:
        ipv4_address: ${IP_FREEIPA:-172.20.0.10}
    ports:
      # Use high ports for rootless podman compatibility
      - "4443:443"        # HTTPS (was 443)
      - "8180:80"         # HTTP (was 80)
      - "3390:389"        # LDAP (was 389)
      - "6360:636"        # LDAPS (was 636)
      - "8800:88"         # Kerberos (was 88)
      - "8800:88/udp"
      - "4640:464"        # Kpasswd (was 464)
      - "4640:464/udp"
    # Start systemd and wait for manual PKI initialization
    command: ["/usr/sbin/init"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sk https://localhost/ipa/config/ca.crt || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 300s

  # ===========================================================================
  # Event Streaming Infrastructure
  # ===========================================================================

  zookeeper:
    image: confluentinc/cp-zookeeper:${ZOOKEEPER_VERSION:-7.5.0}
    container_name: zookeeper
    hostname: zookeeper.${LAB_DOMAIN:-cert-lab.local}
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-log:/var/lib/zookeeper/log
    networks:
      lab-network:
        ipv4_address: ${IP_ZOOKEEPER:-172.20.0.30}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  kafka:
    image: confluentinc/cp-kafka:${KAFKA_VERSION:-7.5.0}
    container_name: kafka
    hostname: kafka.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper.${LAB_DOMAIN:-cert-lab.local}:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka.${LAB_DOMAIN:-cert-lab.local}:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      lab-network:
        ipv4_address: ${IP_KAFKA:-172.20.0.31}
    ports:
      - "9092:9092"
      - "29092:29092"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # AWX Automation Platform
  # ===========================================================================

  postgres:
    image: postgres:${POSTGRES_VERSION:-15}
    container_name: postgres
    hostname: postgres.${LAB_DOMAIN:-cert-lab.local}
    environment:
      POSTGRES_USER: awx
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD required}
      POSTGRES_DB: awx
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      lab-network:
        ipv4_address: ${IP_POSTGRES:-172.20.0.20}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U awx -d awx"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:${REDIS_VERSION:-7}
    container_name: redis
    hostname: redis.${LAB_DOMAIN:-cert-lab.local}
    volumes:
      - redis-data:/data
    networks:
      lab-network:
        ipv4_address: ${IP_REDIS:-172.20.0.21}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AWX requires database initialization - using ansible-runner for simpler lab setup
  # For full AWX, see: https://github.com/ansible/awx/blob/devel/tools/docker-compose/
  awx-web:
    image: quay.io/ansible/awx-ee:${AWX_EE_VERSION:-latest}
    container_name: awx-web
    hostname: awx.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_HOST: postgres.${LAB_DOMAIN:-cert-lab.local}
      DATABASE_NAME: awx
      DATABASE_USER: awx
      DATABASE_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD required}
      DATABASE_PORT: 5432
      REDIS_HOST: redis.${LAB_DOMAIN:-cert-lab.local}
      REDIS_PORT: 6379
      AWX_ADMIN_USER: admin
      AWX_ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD required}
      SECRET_KEY: ${AWX_SECRET_KEY:-redhat123secretkey}
    volumes:
      - awx-projects:/var/lib/awx/projects
      - ./ansible:/runner/project:ro
      - ./ansible/inventory:/runner/inventory:ro
    networks:
      lab-network:
        ipv4_address: ${IP_AWX_WEB:-172.20.0.22}
    ports:
      - "8084:8080"       # AWX web UI (was 8080, changed to avoid conflicts)
    # Keep container running for manual playbook execution
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "true"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Ansible Runner for executing playbooks (simpler than full AWX for lab)
  awx-task:
    image: quay.io/ansible/awx-ee:${AWX_EE_VERSION:-latest}
    container_name: awx-task
    hostname: awx-task.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      - awx-web
    environment:
      ANSIBLE_HOST_KEY_CHECKING: "False"
    volumes:
      - awx-projects:/var/lib/awx/projects
      - ./ansible:/runner/project:ro
      - ./ansible/inventory:/runner/inventory:ro
    networks:
      lab-network:
        ipv4_address: ${IP_AWX_TASK:-172.20.0.23}
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "true"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Event-Driven Ansible
  # ===========================================================================

  # Event-Driven Ansible using ansible-rulebook
  eda-server:
    image: quay.io/ansible/ansible-rulebook:${EDA_VERSION:-v1.0.0}
    container_name: eda-server
    hostname: eda.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      kafka:
        condition: service_healthy
      awx-web:
        condition: service_started
    environment:
      ANSIBLE_HOST_KEY_CHECKING: "False"
      KAFKA_BOOTSTRAP_SERVERS: kafka.${LAB_DOMAIN:-cert-lab.local}:9092
      LAB_LOG_DIR: /opt/cert-lab/logs
      PKI_ADMIN_PASSWORD: ${PKI_ADMIN_PASSWORD:-}
      # Lab host settings for SSH-based revocation
      LAB_HOST_IP: ${LAB_HOST_IP:-host.containers.internal}
      LAB_HOST_USER: ${LAB_HOST_USER:-}
      LAB_ROOT_DIR: ${LAB_ROOT_DIR:-}
    extra_hosts:
      # PKI CA hostnames - use host-gateway to reach PKI via host port mappings
      # PKI runs rootful on separate network, accessible via host ports:
      #   Root CA: 8443, Intermediate CA: 8444, IoT CA: 8445, ACME CA: 8446
      - "root-ca.cert-lab.local:host-gateway"
      - "intermediate-ca.cert-lab.local:host-gateway"
      - "iot-ca.cert-lab.local:host-gateway"
      - "acme-ca.cert-lab.local:host-gateway"
      # ECC PKI (ports 8463-8465)
      - "ecc-root-ca.cert-lab.local:host-gateway"
      - "ecc-intermediate-ca.cert-lab.local:host-gateway"
      - "ecc-iot-ca.cert-lab.local:host-gateway"
      # PQ PKI (ports 8453-8455)
      - "pq-root-ca.cert-lab.local:host-gateway"
      - "pq-intermediate-ca.cert-lab.local:host-gateway"
      - "pq-iot-ca.cert-lab.local:host-gateway"
    volumes:
      - ./ansible/rulebooks:/rulebooks:ro
      - ./ansible/playbooks:/playbooks:ro
      - ./ansible/inventory:/inventory:ro
      - ./ansible/collections:/collections:ro
      - ./data/logs:/opt/cert-lab/logs
      - ./data/certs:/certs:ro
      - ./data/nssdb:/nssdb:ro
      # Mount scripts for revocation helper
      - ./scripts:/scripts:ro
      # SSH keys for connecting to lab host (to run pki-cli.py)
      # Run ./scripts/setup-eda-ssh.sh to generate keys before starting EDA
      - ./data/eda-ssh:/app/.ssh:ro
      # Note: Podman socket not mounted because EDA (rootless) can't access
      # rootful PKI containers. Revocation uses SSH to host instead.
    networks:
      lab-network:
        ipv4_address: ${IP_EDA:-172.20.0.40}
    ports:
      - "5000:5000"
    restart: unless-stopped
    # Wrapper script waits for Kafka and restarts ansible-rulebook on failure
    command: >
      /bin/bash /scripts/eda-entrypoint.sh
      --rulebook /rulebooks/security-events.yml
      --inventory /inventory/hosts.yml
      --verbose
    healthcheck:
      # Check wrapper script is running (PID 1) and ansible-rulebook is a child
      test: ["CMD-SHELL", "pgrep -f ansible-rulebook > /dev/null 2>&1 || grep -q eda-entrypoint /proc/1/cmdline"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ===========================================================================
  # Mock Security Tools
  # ===========================================================================

  mock-edr:
    build:
      context: ./containers/mock-edr
      dockerfile: Containerfile
    container_name: mock-edr
    hostname: edr.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka.${LAB_DOMAIN:-cert-lab.local}:9092
      KAFKA_TOPIC: ${KAFKA_TOPIC_SECURITY:-security-events}
      LAB_DOMAIN: ${LAB_DOMAIN:-cert-lab.local}
    networks:
      lab-network:
        ipv4_address: ${IP_EDR:-172.20.0.50}
    ports:
      - "8082:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/health | grep -q '\"kafka_connected\": true' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 60s

  mock-siem:
    build:
      context: ./containers/mock-siem
      dockerfile: Containerfile
    container_name: mock-siem
    hostname: siem.${LAB_DOMAIN:-cert-lab.local}
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka.${LAB_DOMAIN:-cert-lab.local}:9092
      KAFKA_TOPIC: ${KAFKA_TOPIC_SECURITY:-security-events}
      LAB_DOMAIN: ${LAB_DOMAIN:-cert-lab.local}
    networks:
      lab-network:
        ipv4_address: ${IP_SIEM:-172.20.0.51}
    ports:
      - "8083:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/health | grep -q '\"kafka_connected\": true' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # IoT Client Simulator (EST Enrollment)
  # ===========================================================================

  iot-client:
    build:
      context: ./containers/iot-client
      dockerfile: Containerfile
    container_name: iot-client
    hostname: iot-client.${LAB_DOMAIN:-cert-lab.local}
    environment:
      # RSA IoT CA (port 8445 from host, 8443 internal)
      RSA_IOT_CA_HOST: iot-ca.cert-lab.local
      RSA_IOT_CA_PORT: 8445
      # ECC IoT CA (port 8465 from host, 8443 internal)
      ECC_IOT_CA_HOST: ecc-iot-ca.cert-lab.local
      ECC_IOT_CA_PORT: 8465
      # PQC IoT CA (port 8455 from host, 8443 internal)
      PQC_IOT_CA_HOST: pq-iot-ca.cert-lab.local
      PQC_IOT_CA_PORT: 8455
      LAB_DOMAIN: ${LAB_DOMAIN:-cert-lab.local}
    extra_hosts:
      # Allow connecting to PKI CAs via localhost ports
      - "iot-ca.cert-lab.local:host-gateway"
      - "ecc-iot-ca.cert-lab.local:host-gateway"
      - "pq-iot-ca.cert-lab.local:host-gateway"
    networks:
      lab-network:
        ipv4_address: ${IP_IOT_CLIENT:-172.20.0.52}
    ports:
      - "8085:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ===========================================================================
  # Jupyter Lab (Documentation, Demos, and Dashboard)
  # ===========================================================================

  jupyter:
    image: jupyter/minimal-notebook:${JUPYTER_VERSION:-latest}
    container_name: jupyter
    hostname: jupyter.${LAB_DOMAIN:-cert-lab.local}
    environment:
      JUPYTER_TOKEN: ${JUPYTER_TOKEN:?JUPYTER_TOKEN required}
      JUPYTER_ENABLE_LAB: "yes"
      KAFKA_BOOTSTRAP_SERVERS: kafka.${LAB_DOMAIN:-cert-lab.local}:9092
      KAFKA_TOPIC: security-events
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data/certs:/home/jovyan/certs:ro
      - ./data/logs:/home/jovyan/logs:ro
    networks:
      lab-network:
        ipv4_address: ${IP_JUPYTER:-172.20.0.60}
    ports:
      - "8888:8888"
    # Install kafka-python on startup
    command: >
      bash -c "pip install --quiet kafka-python pandas ipywidgets &&
               start-notebook.sh --NotebookApp.token='${JUPYTER_TOKEN}'"

# ===========================================================================
# Networks
# ===========================================================================

networks:
  lab-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${LAB_SUBNET:-172.20.0.0/16}
          gateway: ${LAB_GATEWAY:-172.20.0.1}

# ===========================================================================
# Volumes
# ===========================================================================

volumes:
  # 389 Directory Server volumes
  ds-root-data:
  ds-intermediate-data:
  ds-iot-data:

  # Dogtag PKI volumes
  pki-root-data:
  pki-root-logs:
  pki-intermediate-data:
  pki-intermediate-logs:
  pki-iot-data:
  pki-iot-logs:

  # FreeIPA volume
  freeipa-data:

  # Kafka/Zookeeper volumes
  zookeeper-data:
  zookeeper-log:
  kafka-data:

  # AWX volumes
  postgres-data:
  redis-data:
  awx-projects:
