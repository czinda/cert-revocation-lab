---
# Security Events Rulebook
# Consumes security events from Kafka and triggers automated responses
#
# Event sources: Mock EDR and Mock SIEM publishing to Kafka topic "security-events"
# Actions: Run playbooks for certificate revocation based on event severity and type
#
# Supports three PKI deployments:
#   - RSA-4096: Traditional cryptography (dogtag-rsa-*)
#   - ECC P-384: Elliptic curve cryptography (dogtag-ecc-*)
#   - ML-DSA-87: Post-quantum cryptography (dogtag-pqc-*)
#
# Every event type has explicit RSA/ECC/PQC rules. RSA is the default when
# pki_type is not specified.

- name: Security Event Processor
  hosts: all
  sources:
    # Kafka event source - consumes security events
    - ansible.eda.kafka:
        host: kafka.cert-lab.local
        port: 9092
        topic: security-events
        group_id: eda-security-processor
        offset: earliest

  rules:
    # =========================================================================
    # ORIGINAL EVENT TYPES - Malware, credential theft, ransomware, etc.
    # =========================================================================

    # --- Critical malware detection ---
    - name: Critical Malware Detection - RSA
      condition: >
        event.body.source in ["edr", "siem"] and
        event.body.event_type == "malware_detection" and
        event.body.severity == "critical" and
        event.body.action_required == "revoke_certificate" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "intermediate"

    - name: Critical Malware Detection - ECC
      condition: >
        event.body.source in ["edr", "siem"] and
        event.body.event_type == "malware_detection" and
        event.body.severity == "critical" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "intermediate"

    - name: Critical Malware Detection - PQC
      condition: >
        event.body.source in ["edr", "siem"] and
        event.body.event_type == "malware_detection" and
        event.body.severity == "critical" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "intermediate"

    # --- Credential theft ---
    - name: Credential Theft Detected - RSA
      condition: >
        event.body.event_type == "credential_theft" and
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Credential Theft Detected - ECC
      condition: >
        event.body.event_type == "credential_theft" and
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Credential Theft Detected - PQC
      condition: >
        event.body.event_type == "credential_theft" and
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- High severity malware ---
    - name: High Severity Malware - RSA
      condition: >
        event.body.event_type == "malware_detection" and
        event.body.severity == "high" and
        event.body.action_required == "revoke_certificate" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: High Severity Malware - ECC
      condition: >
        event.body.event_type == "malware_detection" and
        event.body.severity == "high" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: High Severity Malware - PQC
      condition: >
        event.body.event_type == "malware_detection" and
        event.body.severity == "high" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- Ransomware detection ---
    - name: Ransomware Detection - RSA
      condition: >
        event.body.event_type == "ransomware" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"

    - name: Ransomware Detection - ECC
      condition: >
        event.body.event_type == "ransomware" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"

    - name: Ransomware Detection - PQC
      condition: >
        event.body.event_type == "ransomware" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"

    # --- C2 communication ---
    - name: C2 Communication Detected - RSA
      condition: >
        event.body.event_type == "c2_communication" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: C2 Communication Detected - ECC
      condition: >
        event.body.event_type == "c2_communication" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: C2 Communication Detected - PQC
      condition: >
        event.body.event_type == "c2_communication" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- Lateral movement ---
    - name: Lateral Movement Detected - RSA
      condition: >
        event.body.event_type == "lateral_movement" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Lateral Movement Detected - ECC
      condition: >
        event.body.event_type == "lateral_movement" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Lateral Movement Detected - PQC
      condition: >
        event.body.event_type == "lateral_movement" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- Privilege escalation ---
    - name: Privilege Escalation - RSA
      condition: >
        event.body.event_type == "privilege_escalation" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Privilege Escalation - ECC
      condition: >
        event.body.event_type == "privilege_escalation" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Privilege Escalation - PQC
      condition: >
        event.body.event_type == "privilege_escalation" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- Suspicious script ---
    - name: Suspicious Script Execution - RSA
      condition: >
        event.body.event_type == "suspicious_script" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Suspicious Script Execution - ECC
      condition: >
        event.body.event_type == "suspicious_script" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Suspicious Script Execution - PQC
      condition: >
        event.body.event_type == "suspicious_script" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # =========================================================================
    # PKI/CERTIFICATE-SPECIFIC EVENTS - Critical priority
    # =========================================================================

    # --- Key compromise (ca_level from event, defaults to iot in playbook) ---
    - name: Certificate Private Key Compromise - RSA
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            reason: 1  # keyCompromise

    - name: Certificate Private Key Compromise - ECC
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            reason: 1

    - name: Certificate Private Key Compromise - PQC
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            reason: 1

    # --- Geographic anomaly ---
    - name: Certificate Used from Unusual Location - RSA
      condition: >
        event.body.event_type == "geo_anomaly" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Used from Unusual Location - ECC
      condition: >
        event.body.event_type == "geo_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Used from Unusual Location - PQC
      condition: >
        event.body.event_type == "geo_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # --- Compliance violation ---
    - name: Expired Certificate Compliance Violation - RSA
      condition: >
        event.body.event_type == "compliance_violation" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 5  # cessationOfOperation

    - name: Expired Certificate Compliance Violation - ECC
      condition: >
        event.body.event_type == "compliance_violation" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 5

    - name: Expired Certificate Compliance Violation - PQC
      condition: >
        event.body.event_type == "compliance_violation" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 5

    # --- MITM / certificate pinning violation ---
    - name: Certificate Pinning Violation - MITM Attack - RSA
      condition: >
        event.body.event_type == "mitm_detected" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Pinning Violation - MITM Attack - ECC
      condition: >
        event.body.event_type == "mitm_detected" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Pinning Violation - MITM Attack - PQC
      condition: >
        event.body.event_type == "mitm_detected" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # --- Rogue CA detected ---
    - name: Rogue CA Certificate Detected - RSA
      condition: >
        event.body.event_type == "rogue_ca" and
        event.body.severity == "critical" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "root"
            reason: 2  # caCompromise

    - name: Rogue CA Certificate Detected - ECC
      condition: >
        event.body.event_type == "rogue_ca" and
        event.body.severity == "critical" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "root"
            reason: 2

    - name: Rogue CA Certificate Detected - PQC
      condition: >
        event.body.event_type == "rogue_ca" and
        event.body.severity == "critical" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "root"
            reason: 2

    # =========================================================================
    # IoT-SPECIFIC EVENTS - Route to IoT Sub-CA
    # =========================================================================

    # --- IoT firmware tampering ---
    - name: IoT Firmware Tampering - RSA
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    - name: IoT Firmware Tampering - ECC
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    - name: IoT Firmware Tampering - PQC
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    # --- IoT device cloning ---
    - name: IoT Device Cloning Detected - RSA
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    - name: IoT Device Cloning Detected - ECC
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    - name: IoT Device Cloning Detected - PQC
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    # --- Anomalous IoT behavior ---
    - name: Anomalous IoT Behavior - RSA
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: Anomalous IoT Behavior - ECC
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: Anomalous IoT Behavior - PQC
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    # --- IoT protocol exploitation ---
    - name: IoT Protocol Exploitation - RSA
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: IoT Protocol Exploitation - ECC
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: IoT Protocol Exploitation - PQC
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    # =========================================================================
    # IDENTITY/ACCESS EVENTS - Route to Intermediate CA
    # =========================================================================

    # --- Impossible travel ---
    - name: Impossible Travel Detected - RSA
      condition: >
        event.body.event_type == "impossible_travel" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Impossible Travel Detected - ECC
      condition: >
        event.body.event_type == "impossible_travel" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Impossible Travel Detected - PQC
      condition: >
        event.body.event_type == "impossible_travel" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # --- Service account abuse ---
    - name: Service Account Abuse Detected - RSA
      condition: >
        event.body.event_type == "service_account_abuse" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Service Account Abuse Detected - ECC
      condition: >
        event.body.event_type == "service_account_abuse" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Service Account Abuse Detected - PQC
      condition: >
        event.body.event_type == "service_account_abuse" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # --- MFA bypass ---
    - name: MFA Bypass Attempt Detected - RSA
      condition: >
        event.body.event_type == "mfa_bypass" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: MFA Bypass Attempt Detected - ECC
      condition: >
        event.body.event_type == "mfa_bypass" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: MFA Bypass Attempt Detected - PQC
      condition: >
        event.body.event_type == "mfa_bypass" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # --- Kerberoasting ---
    - name: Kerberoasting Attack Detected - RSA
      condition: >
        event.body.event_type == "kerberoasting" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Kerberoasting Attack Detected - ECC
      condition: >
        event.body.event_type == "kerberoasting" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: Kerberoasting Attack Detected - PQC
      condition: >
        event.body.event_type == "kerberoasting" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # --- FreeIPA identity revocation (fires alongside Dogtag rules) ---
    - name: Impossible Travel - FreeIPA
      condition: >
        event.body.event_type == "impossible_travel" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: /playbooks/freeipa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"

    - name: Service Account Abuse - FreeIPA
      condition: >
        event.body.event_type == "service_account_abuse" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: /playbooks/freeipa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"

    - name: MFA Bypass - FreeIPA
      condition: >
        event.body.event_type == "mfa_bypass" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: /playbooks/freeipa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"

    - name: Kerberoasting - FreeIPA
      condition: >
        event.body.event_type == "kerberoasting" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: /playbooks/freeipa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"

    # =========================================================================
    # NETWORK SECURITY EVENTS
    # =========================================================================

    # --- TLS downgrade attack ---
    - name: TLS Downgrade Attack Detected - RSA
      condition: >
        event.body.event_type == "tls_downgrade" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: TLS Downgrade Attack Detected - ECC
      condition: >
        event.body.event_type == "tls_downgrade" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: TLS Downgrade Attack Detected - PQC
      condition: >
        event.body.event_type == "tls_downgrade" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # --- Certificate transparency log mismatch ---
    - name: Certificate Transparency Log Mismatch - RSA
      condition: >
        event.body.event_type == "ct_log_mismatch" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Transparency Log Mismatch - ECC
      condition: >
        event.body.event_type == "ct_log_mismatch" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Transparency Log Mismatch - PQC
      condition: >
        event.body.event_type == "ct_log_mismatch" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # --- OCSP bypass ---
    - name: OCSP Bypass Attempt Detected - RSA
      condition: >
        event.body.event_type == "ocsp_bypass" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: OCSP Bypass Attempt Detected - ECC
      condition: >
        event.body.event_type == "ocsp_bypass" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    - name: OCSP Bypass Attempt Detected - PQC
      condition: >
        event.body.event_type == "ocsp_bypass" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # =========================================================================
    # SIEM CORRELATION RULES
    # =========================================================================

    # --- Data exfiltration ---
    - name: Data Exfiltration Correlated - RSA
      condition: >
        event.body.event_type == "data_exfiltration" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Data Exfiltration Correlated - ECC
      condition: >
        event.body.event_type == "data_exfiltration" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Data Exfiltration Correlated - PQC
      condition: >
        event.body.event_type == "data_exfiltration" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # --- Unauthorized access ---
    - name: Unauthorized Access Correlated - RSA
      condition: >
        event.body.event_type == "unauthorized_access" and
        event.body.action_required == "revoke_certificate" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "medium"
            ca_level: "intermediate"

    - name: Unauthorized Access Correlated - ECC
      condition: >
        event.body.event_type == "unauthorized_access" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "medium"
            ca_level: "intermediate"

    - name: Unauthorized Access Correlated - PQC
      condition: >
        event.body.event_type == "unauthorized_access" and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "medium"
            ca_level: "intermediate"

    # --- Certificate misuse ---
    - name: Certificate Misuse - RSA
      condition: >
        event.body.event_type == "certificate_misuse" and
        (event.body.pki_type is not defined or event.body.pki_type == null or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: /playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Certificate Misuse - ECC
      condition: >
        event.body.event_type == "certificate_misuse" and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: /playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    - name: Certificate Misuse - PQC
      condition: >
        event.body.event_type == "certificate_misuse" and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: /playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # =========================================================================
    # LOGGING AND AUDIT
    # =========================================================================

    # Log unhandled high/critical events
    - name: Log Unhandled Critical Events
      condition: >
        event.body.severity in ["high", "critical"] and
        event.body.action_required != "revoke_certificate"
      action:
        debug:
          msg: |
            Unhandled critical event:
            Event ID: {{ event.body.event_id }}
            Type: {{ event.body.event_type }}
            Device: {{ event.body.device_fqdn | default('unknown') }}
            Severity: {{ event.body.severity }}
            Action Required: {{ event.body.action_required }}
            PKI Type: {{ event.body.pki_type | default('not specified') }}

    # Audit log all events
    - name: Audit Log All Events
      condition: event.body.event_id is defined
      action:
        debug:
          msg: "EVENT RECEIVED: {{ event.body.event_id }} | {{ event.body.event_type }} | {{ event.body.severity }} | PKI: {{ event.body.pki_type | default('default') }}"
