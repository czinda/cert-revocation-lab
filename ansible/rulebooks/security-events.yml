---
# Security Events Rulebook
# Consumes security events from Kafka and triggers automated responses
#
# Event sources: Mock EDR and Mock SIEM publishing to Kafka topic "security-events"
# Actions: Run playbooks for certificate revocation based on event severity and type
#
# Supports three PKI deployments:
#   - RSA-4096: Traditional cryptography (dogtag-rsa-*)
#   - ECC P-384: Elliptic curve cryptography (dogtag-ecc-*)
#   - ML-DSA-87: Post-quantum cryptography (dogtag-pqc-*)

- name: Security Event Processor
  hosts: all
  sources:
    # Kafka event source - consumes security events
    - ansible.eda.kafka:
        host: kafka.cert-lab.local
        port: 9092
        topic: security-events
        group_id: eda-security-processor
        offset: earliest

  rules:
    # =========================================================================
    # ORIGINAL EVENT TYPES - Route to FreeIPA or default Dogtag RSA
    # Note: Kafka source wraps messages in {meta, body} - use event.body.*
    # =========================================================================

    # Rule 1: Critical malware detection - immediate revocation
    - name: Critical Malware Detection - Immediate Revocation
      condition: >
        event.body.source in ["edr", "siem"] and
        event.body.event_type == "malware_detection" and
        event.body.severity == "critical" and
        event.body.action_required == "revoke_certificate"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "intermediate"

    # Rule 2: Credential theft - immediate revocation
    - name: Credential Theft Detected - Revoke Certificate
      condition: >
        event.body.event_type == "credential_theft" and
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 3: High severity malware - revocation
    - name: High Severity Malware - Revoke Certificate
      condition: >
        event.body.event_type == "malware_detection" and
        event.body.severity == "high" and
        event.body.action_required == "revoke_certificate"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 4: Ransomware detection - emergency revocation
    - name: Ransomware Detection - Emergency Revocation
      condition: >
        event.body.event_type == "ransomware" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"

    # Rule 5: C2 communication - revocation
    - name: C2 Communication Detected - Revoke Certificate
      condition: >
        event.body.event_type == "c2_communication" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 6: Lateral movement - revocation
    - name: Lateral Movement Detected - Revoke Certificate
      condition: >
        event.body.event_type == "lateral_movement" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 7: Privilege escalation - revocation
    - name: Privilege Escalation - Revoke Certificate
      condition: >
        event.body.event_type == "privilege_escalation" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 8: Suspicious script - revocation
    - name: Suspicious Script Execution - Revoke Certificate
      condition: >
        event.body.event_type == "suspicious_script" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # =========================================================================
    # PKI/CERTIFICATE-SPECIFIC EVENTS - Critical priority
    # =========================================================================

    # Rule 9: Key compromise - immediate revocation (all PKI types)
    - name: Certificate Private Key Compromise - RSA
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1  # keyCompromise

    - name: Certificate Private Key Compromise - ECC
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    - name: Certificate Private Key Compromise - PQC
      condition: >
        event.body.event_type == "key_compromise" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # Rule 10: Geographic anomaly - potential credential theft
    - name: Certificate Used from Unusual Location
      condition: >
        event.body.event_type == "geo_anomaly" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # Rule 11: Compliance violation - expired cert in use
    - name: Expired Certificate Compliance Violation
      condition: >
        event.body.event_type == "compliance_violation" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 5  # cessationOfOperation

    # Rule 12: MITM detected - certificate pinning violation
    - name: Certificate Pinning Violation - MITM Attack
      condition: >
        event.body.event_type == "mitm_detected" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # Rule 13: Rogue CA detected - CA compromise
    - name: Rogue CA Certificate Detected
      condition: >
        event.body.event_type == "rogue_ca" and
        event.body.severity == "critical"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "root"  # May need root CA action
            reason: 2  # caCompromise

    # =========================================================================
    # IoT-SPECIFIC EVENTS - Route to IoT Sub-CA
    # =========================================================================

    # Rule 14: IoT firmware tampering - RSA IoT CA
    - name: IoT Firmware Tampering - RSA
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    - name: IoT Firmware Tampering - ECC
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    - name: IoT Firmware Tampering - PQC
      condition: >
        event.body.event_type == "firmware_integrity" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "critical"
            ca_level: "iot"
            reason: 1

    # Rule 15: IoT device cloning - immediate revocation
    - name: IoT Device Cloning Detected - RSA
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    - name: IoT Device Cloning Detected - ECC
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    - name: IoT Device Cloning Detected - PQC
      condition: >
        event.body.event_type == "device_cloning" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "iot"
            reason: 1

    # Rule 16: Anomalous IoT behavior
    - name: Anomalous IoT Behavior - RSA
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: Anomalous IoT Behavior - ECC
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: Anomalous IoT Behavior - PQC
      condition: >
        event.body.event_type == "iot_anomaly" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    # Rule 17: IoT protocol exploitation
    - name: IoT Protocol Exploitation - RSA
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        (event.body.pki_type is not defined or event.body.pki_type == "rsa")
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: IoT Protocol Exploitation - ECC
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "ecc"
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    - name: IoT Protocol Exploitation - PQC
      condition: >
        event.body.event_type == "protocol_attack" and
        event.body.severity in ["high", "critical"] and
        event.body.pki_type == "pqc"
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "iot"
            reason: 1

    # =========================================================================
    # IDENTITY/ACCESS EVENTS - Route to Intermediate CA
    # =========================================================================

    # Rule 18: Impossible travel - credential compromise
    - name: Impossible Travel Detected
      condition: >
        event.body.event_type == "impossible_travel" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # Rule 19: Service account abuse
    - name: Service Account Abuse Detected
      condition: >
        event.body.event_type == "service_account_abuse" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # Rule 20: MFA bypass attempt
    - name: MFA Bypass Attempt Detected
      condition: >
        event.body.event_type == "mfa_bypass" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # Rule 21: Kerberoasting detected
    - name: Kerberoasting Attack Detected
      condition: >
        event.body.event_type == "kerberoasting" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # =========================================================================
    # NETWORK SECURITY EVENTS
    # =========================================================================

    # Rule 22: TLS downgrade attack
    - name: TLS Downgrade Attack Detected
      condition: >
        event.body.event_type == "tls_downgrade" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # Rule 23: Certificate transparency log mismatch
    - name: Certificate Transparency Log Mismatch
      condition: >
        event.body.event_type == "ct_log_mismatch" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "emergency"
            ca_level: "intermediate"
            reason: 1

    # Rule 24: OCSP stapling failure / bypass
    - name: OCSP Bypass Attempt Detected
      condition: >
        event.body.event_type == "ocsp_bypass" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"
            reason: 1

    # =========================================================================
    # SIEM CORRELATION RULES
    # =========================================================================

    # Rule 25: Data exfiltration correlated
    - name: Data Exfiltration Correlated - Revoke Certificate
      condition: >
        event.body.event_type == "data_exfiltration" and
        event.body.severity in ["high", "critical"]
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 26: Unauthorized access correlated
    - name: Unauthorized Access Correlated - Revoke Certificate
      condition: >
        event.body.event_type == "unauthorized_access" and
        event.body.action_required == "revoke_certificate"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "medium"
            ca_level: "intermediate"

    # Rule 27: Certificate misuse - immediate revocation
    - name: Certificate Misuse - Revoke Certificate
      condition: >
        event.body.event_type == "certificate_misuse"
      action:
        run_playbook:
          name: playbooks/dogtag-rsa-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # =========================================================================
    # PKI-TYPE SPECIFIC ROUTING (when pki_type is explicitly set)
    # =========================================================================

    # Rule 28: Generic high/critical event - ECC PKI
    - name: Generic Security Event - ECC PKI
      condition: >
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "ecc" and
        event.body.event_type not in ["key_compromise", "firmware_integrity", "device_cloning", "iot_anomaly", "protocol_attack"]
      action:
        run_playbook:
          name: playbooks/dogtag-ecc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # Rule 29: Generic high/critical event - PQC PKI
    - name: Generic Security Event - PQC PKI
      condition: >
        event.body.severity in ["high", "critical"] and
        event.body.action_required == "revoke_certificate" and
        event.body.pki_type == "pqc" and
        event.body.event_type not in ["key_compromise", "firmware_integrity", "device_cloning", "iot_anomaly", "protocol_attack"]
      action:
        run_playbook:
          name: playbooks/dogtag-pqc-revoke-certificate.yml
          extra_vars:
            event: "{{ event.body }}"
            priority: "high"
            ca_level: "intermediate"

    # =========================================================================
    # LOGGING AND AUDIT
    # =========================================================================

    # Rule 30: Log unhandled high/critical events
    - name: Log Unhandled Critical Events
      condition: >
        event.body.severity in ["high", "critical"] and
        event.body.action_required != "revoke_certificate"
      action:
        debug:
          msg: |
            Unhandled critical event:
            Event ID: {{ event.body.event_id }}
            Type: {{ event.body.event_type }}
            Device: {{ event.body.device_fqdn | default('unknown') }}
            Severity: {{ event.body.severity }}
            Action Required: {{ event.body.action_required }}
            PKI Type: {{ event.body.pki_type | default('not specified') }}

    # Rule 31: Audit log all events
    - name: Audit Log All Events
      condition: event.body.event_id is defined
      action:
        debug:
          msg: "EVENT RECEIVED: {{ event.body.event_id }} | {{ event.body.event_type }} | {{ event.body.severity }} | PKI: {{ event.body.pki_type | default('default') }}"
