---
# Dogtag RSA-4096 PKI - Certificate Issuance Playbook
# Issues certificates using the RSA-4096 PKI hierarchy
#
# Variables:
#   target_host - FQDN for the certificate subject
#   cert_profile - Certificate profile (caServerCert, caUserCert, caCACert)
#   ca_level - Which CA to use (root, intermediate, iot)
#   output_dir - Directory for certificate output

- name: Issue Certificate - RSA-4096 PKI
  hosts: localhost
  gather_facts: false
  vars:
    # PKI type
    pki_type: "rsa"
    pki_name: "RSA-4096"

    # CA selection
    target_ca: "{{ ca_level | default('intermediate') }}"

    # Certificate request parameters
    target_host: "{{ host_fqdn | default('device.cert-lab.local') }}"
    cert_profile: "{{ profile | default('caServerCert') }}"
    key_size: 4096
    validity_days: 365

    # Output paths
    output_dir: "{{ cert_output_dir | default('/tmp/certs/rsa') }}"
    private_key_file: "{{ output_dir }}/{{ target_host }}.key"
    csr_file: "{{ output_dir }}/{{ target_host }}.csr"
    cert_file: "{{ output_dir }}/{{ target_host }}.crt"

    # Logging
    log_file: "/var/log/dogtag-issuance.log"

    # RSA PKI configuration
    ca_configs:
      root:
        container: "dogtag-root-ca"
        url: "https://root-ca.cert-lab.local:8443"
        instance: "pki-root-ca"
        nss_db: "/var/lib/pki/pki-root-ca/alias"
      intermediate:
        container: "dogtag-intermediate-ca"
        url: "https://intermediate-ca.cert-lab.local:8443"
        instance: "pki-intermediate-ca"
        nss_db: "/var/lib/pki/pki-intermediate-ca/alias"
      iot:
        container: "dogtag-iot-ca"
        url: "https://iot-ca.cert-lab.local:8443"
        instance: "pki-iot-ca"
        nss_db: "/var/lib/pki/pki-iot-ca/alias"

  tasks:
    - name: Set CA configuration
      ansible.builtin.set_fact:
        ca_config: "{{ ca_configs[target_ca] }}"

    - name: Display certificate request info
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - CERTIFICATE ISSUANCE
          ============================================================
          Host:       {{ target_host }}
          Profile:    {{ cert_profile }}
          Key Size:   {{ key_size }} bits
          CA:         {{ target_ca | upper }} ({{ ca_config.container }})
          Output:     {{ output_dir }}
          ============================================================
      tags: [always]

    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0700'
      tags: [setup]

    - name: Block for certificate issuance
      block:
        - name: Generate RSA private key
          ansible.builtin.command:
            cmd: >
              openssl genrsa -out {{ private_key_file }} {{ key_size }}
          args:
            creates: "{{ private_key_file }}"
          tags: [keygen]

        - name: Set private key permissions
          ansible.builtin.file:
            path: "{{ private_key_file }}"
            mode: '0600'
          tags: [keygen]

        - name: Generate CSR
          ansible.builtin.command:
            cmd: >
              openssl req -new
              -key {{ private_key_file }}
              -out {{ csr_file }}
              -subj "/CN={{ target_host }}"
          args:
            creates: "{{ csr_file }}"
          tags: [csr]

        - name: Read CSR content
          ansible.builtin.slurp:
            src: "{{ csr_file }}"
          register: csr_content
          tags: [csr]

        - name: Display CSR info
          ansible.builtin.debug:
            msg: "CSR generated for {{ target_host }}"
          tags: [csr]

        - name: Copy CSR to CA container
          ansible.builtin.shell: |
            podman cp {{ csr_file }} {{ ca_config.container }}:/tmp/request.csr
          tags: [request]

        - name: Submit certificate request to Dogtag
          ansible.builtin.shell: |
            podman exec {{ ca_config.container }} \
              pki -d {{ ca_config.nss_db }} \
                  -c "{{ lookup('env', 'PKI_ADMIN_PASSWORD') | default(lookup('env', 'ADMIN_PASSWORD')) }}" \
                  -n "PKI Administrator for {{ ca_config.instance }}" \
                  -U {{ ca_config.url }} \
                  ca-cert-request-submit \
                  --profile {{ cert_profile }} \
                  --csr-file /tmp/request.csr \
              | grep "Request ID:" | awk '{print $3}'
          register: request_submit
          tags: [request]

        - name: Set request ID
          ansible.builtin.set_fact:
            request_id: "{{ request_submit.stdout | trim }}"
          tags: [request]

        - name: Display request ID
          ansible.builtin.debug:
            msg: "Certificate request submitted - Request ID: {{ request_id }}"
          tags: [request]

        - name: Approve certificate request
          ansible.builtin.shell: |
            podman exec {{ ca_config.container }} \
              pki -d {{ ca_config.nss_db }} \
                  -c "{{ lookup('env', 'PKI_ADMIN_PASSWORD') | default(lookup('env', 'ADMIN_PASSWORD')) }}" \
                  -n "PKI Administrator for {{ ca_config.instance }}" \
                  -U {{ ca_config.url }} \
                  ca-cert-request-approve {{ request_id }} --force
          register: approve_result
          tags: [approve]

        - name: Get certificate serial from approval
          ansible.builtin.shell: |
            podman exec {{ ca_config.container }} \
              pki -d {{ ca_config.nss_db }} \
                  -c "{{ lookup('env', 'PKI_ADMIN_PASSWORD') | default(lookup('env', 'ADMIN_PASSWORD')) }}" \
                  -n "PKI Administrator for {{ ca_config.instance }}" \
                  -U {{ ca_config.url }} \
                  ca-cert-request-show {{ request_id }} \
              | grep "Certificate ID:" | awk '{print $3}'
          register: cert_id_result
          tags: [retrieve]

        - name: Set certificate serial
          ansible.builtin.set_fact:
            cert_serial: "{{ cert_id_result.stdout | trim }}"
          tags: [retrieve]

        - name: Export certificate from Dogtag
          ansible.builtin.shell: |
            podman exec {{ ca_config.container }} \
              pki -d {{ ca_config.nss_db }} \
                  -c "{{ lookup('env', 'PKI_ADMIN_PASSWORD') | default(lookup('env', 'ADMIN_PASSWORD')) }}" \
                  -n "PKI Administrator for {{ ca_config.instance }}" \
                  -U {{ ca_config.url }} \
                  ca-cert-export {{ cert_serial }} --output-file /tmp/cert.pem
          tags: [retrieve]

        - name: Copy certificate from container
          ansible.builtin.shell: |
            podman cp {{ ca_config.container }}:/tmp/cert.pem {{ cert_file }}
          tags: [retrieve]

        - name: Verify certificate
          ansible.builtin.command:
            cmd: "openssl x509 -in {{ cert_file }} -noout -subject -issuer -dates -serial"
          register: cert_info
          tags: [verify]

        - name: Display certificate info
          ansible.builtin.debug:
            msg: "{{ cert_info.stdout_lines }}"
          tags: [verify]

        - name: Log issuance to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | SERIAL={{ cert_serial }} | CN={{ target_host }} | PROFILE={{ cert_profile }} | STATUS=ISSUED"
            create: true
            mode: '0644'
          delegate_to: localhost
          tags: [logging]

      rescue:
        - name: Log failure
          ansible.builtin.debug:
            msg: "Certificate issuance failed: {{ ansible_failed_result.msg | default('Unknown error') }}"
          tags: [error]

        - name: Log error to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | CN={{ target_host }} | STATUS=FAILED | ERROR={{ ansible_failed_result.msg | default('Unknown') }}"
            create: true
            mode: '0644'
          delegate_to: localhost
          tags: [error, logging]

    - name: Summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - CERTIFICATE ISSUED
          ============================================================
          Serial:      {{ cert_serial | default('N/A') }}
          Subject:     CN={{ target_host }}
          CA:          {{ target_ca | upper }}
          Profile:     {{ cert_profile }}

          Files:
            Private Key: {{ private_key_file }}
            Certificate: {{ cert_file }}
            CSR:         {{ csr_file }}

          {{ cert_info.stdout | default('') }}
          ============================================================
      tags: [always]
