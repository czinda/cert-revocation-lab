---
# Dogtag RSA-4096 PKI - Certificate Revocation Playbook
# Revokes certificates using the Dogtag REST API (no podman access required)
#
# Expected variables from EDA:
#   event.device_fqdn - Device FQDN whose certificate should be revoked
#   event.certificate_cn - Certificate Common Name (optional)
#   event.certificate_serial - Certificate serial number (hex, e.g. 0x1a2b)
#   event.severity - Event severity (low, medium, high, critical)
#   event.event_id - Unique event identifier
#   event.description - Event description

- name: Revoke Certificate - RSA-4096 PKI (REST API)
  hosts: localhost
  gather_facts: false
  vars:
    # PKI type
    pki_type: "rsa"
    pki_name: "RSA-4096"

    # CA selection (root, intermediate, iot, est, acme)
    # Prefer event.ca_level (set by test/caller) so revocation targets the correct CA,
    # fall back to ca_level from rulebook extra_vars, then default to iot
    target_ca: "{{ event.ca_level | default(ca_level | default('iot', true), true) }}"

    # Event data (passed from EDA)
    # Use 'default(value, true)' to treat null/None as undefined
    device_fqdn: "{{ event.device_fqdn | default('unknown.cert-lab.local', true) }}"
    certificate_cn: "{{ event.certificate_cn | default(device_fqdn, true) }}"
    certificate_serial: "{{ event.certificate_serial | default('', true) }}"
    event_severity: "{{ event.severity | default('high', true) }}"
    event_id: "{{ event.event_id | default('manual', true) }}"
    event_description: "{{ event.description | default('Security incident', true) }}"

    # Revocation settings
    # CRL reason codes and their string values for Dogtag REST API:
    #   0 = UNSPECIFIED
    #   1 = KEY_COMPROMISE
    #   2 = CA_COMPROMISE
    #   3 = AFFILIATION_CHANGED
    #   4 = SUPERSEDED
    #   5 = CESSATION_OF_OPERATION
    #   6 = CERTIFICATE_HOLD
    #   9 = PRIVILEGE_WITHDRAWN
    revocation_reason_code: "{{ reason | default(1) }}"
    # Map reason codes to Dogtag REST API string values
    reason_map:
      0: "UNSPECIFIED"
      1: "KEY_COMPROMISE"
      2: "CA_COMPROMISE"
      3: "AFFILIATION_CHANGED"
      4: "SUPERSEDED"
      5: "CESSATION_OF_OPERATION"
      6: "CERTIFICATE_HOLD"
      9: "PRIVILEGE_WITHDRAWN"
    revocation_reason: "{{ reason_map[revocation_reason_code | int] | default('KEY_COMPROMISE') }}"
    log_file: "{{ lookup('env', 'LAB_LOG_DIR') | default('/opt/cert-lab/logs', true) }}/dogtag-revocation.log"

    # Certificate paths (mounted from host via compose)
    certs_dir: "/certs"
    admin_creds_dir: "{{ certs_dir }}/admin"

    # RSA PKI configuration - REST API URLs
    # Note: Use external host ports since EDA runs on separate network
    #   Root CA: 8443, Intermediate CA: 8444, IoT CA: 8445
    ca_configs:
      root:
        name: "Root CA"
        url: "https://root-ca.cert-lab.local:8443"
        admin_cert: "{{ admin_creds_dir }}/root-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/root-admin-key.pem"
        ca_cert: "{{ certs_dir }}/root-ca.crt"
      intermediate:
        name: "Intermediate CA"
        url: "https://intermediate-ca.cert-lab.local:8444"
        admin_cert: "{{ admin_creds_dir }}/intermediate-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/intermediate-admin-key.pem"
        ca_cert: "{{ certs_dir }}/ca-chain.crt"
      iot:
        name: "IoT CA"
        url: "https://iot-ca.cert-lab.local:8445"
        admin_cert: "{{ admin_creds_dir }}/iot-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/iot-admin-key.pem"
        ca_cert: "{{ certs_dir }}/iot-ca-chain.crt"
      est:
        name: "EST CA"
        url: "https://est-ca.cert-lab.local:8447"
        admin_cert: "{{ admin_creds_dir }}/est-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/est-admin-key.pem"
        ca_cert: "{{ certs_dir }}/est-ca-chain.crt"
      acme:
        name: "ACME CA"
        url: "https://acme-ca.cert-lab.local:8446"
        admin_cert: "{{ admin_creds_dir }}/acme-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/acme-admin-key.pem"
        ca_cert: "{{ certs_dir }}/acme-ca-chain.crt"

  tasks:
    - name: Set CA configuration
      ansible.builtin.set_fact:
        ca_config: "{{ ca_configs[target_ca] }}"

    - name: Display revocation request
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - CERTIFICATE REVOCATION (REST API)
          ============================================================
          Event ID:      {{ event_id }}
          Device:        {{ device_fqdn }}
          Certificate:   {{ certificate_cn }}
          Serial:        {{ certificate_serial | default('auto-detect') }}
          Severity:      {{ event_severity }}
          Target CA:     {{ target_ca | upper }} ({{ ca_config.name }})
          CA URL:        {{ ca_config.url }}
          Reason:        {{ revocation_reason }}
          Description:   {{ event_description }}
          ============================================================
      tags: [always]

    - name: Validate severity for automatic revocation
      ansible.builtin.assert:
        that:
          - event_severity in ['high', 'critical']
        fail_msg: "Severity '{{ event_severity }}' does not trigger automatic revocation"
      when: not (force_revoke | default(false) | bool)
      tags: [validation]

    - name: Check admin credentials exist
      ansible.builtin.stat:
        path: "{{ ca_config.admin_cert }}"
      register: admin_cert_stat
      tags: [validation]

    - name: Fail if admin credentials missing
      ansible.builtin.fail:
        msg: |
          Admin credentials not found: {{ ca_config.admin_cert }}
          Run the PKI init script to export admin credentials:
            sudo podman exec dogtag-{{ target_ca }}-ca /scripts/init-{{ target_ca }}-ca.sh
      when: not admin_cert_stat.stat.exists
      tags: [validation]

    # All operations via SSH to lab host (bypasses REST API SSL trust issues)
    - name: Block for Dogtag PKI CLI operations via SSH
      block:
        - name: Use provided certificate serial
          ansible.builtin.set_fact:
            cert_serial: "{{ certificate_serial | regex_replace('^0x', '') }}"
          when: certificate_serial != ''
          tags: [lookup]

        - name: Search for certificate by subject via SSH (if serial not provided)
          ansible.builtin.shell:
            cmd: |
              cd {{ hostvars['lab-host'].lab_root_dir | default('/home/czinda/cert-revocation-lab') }}
              sudo podman exec dogtag-{{ target_ca }}-ca pki -d /root/.dogtag/nssdb -c '' \
                ca-cert-find --name "{{ certificate_cn }}" --status VALID 2>/dev/null \
                | grep "Serial Number:" | head -1 | awk '{print $3}' | sed 's/^0x//'
          delegate_to: lab-host
          register: cert_search_result
          when: certificate_serial == ''
          tags: [lookup]

        - name: Set certificate serial from search
          ansible.builtin.set_fact:
            cert_serial: "{{ cert_search_result.stdout | trim }}"
          when: certificate_serial == '' and cert_search_result.stdout | default('') | trim != ''
          tags: [lookup]

        - name: Verify certificate serial found
          ansible.builtin.fail:
            msg: "No valid certificate found for {{ certificate_cn }}"
          when: cert_serial is not defined or cert_serial == ''
          tags: [validation]

        - name: Display certificate to revoke
          ansible.builtin.debug:
            msg: "Found certificate serial: 0x{{ cert_serial }}"
          tags: [lookup]

        - name: Revoke certificate via SSH to lab host
          ansible.builtin.shell:
            cmd: |
              cd {{ hostvars['lab-host'].lab_root_dir | default('/home/czinda/cert-revocation-lab') }}
              ./scripts/pki-cli.py revoke 0x{{ cert_serial }} --ca {{ target_ca }} --reason key_compromise
          delegate_to: lab-host
          register: revoke_result
          tags: [revoke]

        - name: Display revocation result
          ansible.builtin.debug:
            msg: "{{ revoke_result.stdout_lines | default(['Revocation command executed']) }}"
          tags: [revoke]

        - name: Wait for revocation to process
          ansible.builtin.pause:
            seconds: 2
          tags: [verify]

        - name: Verify revocation status via SSH
          ansible.builtin.shell:
            cmd: |
              cd {{ hostvars['lab-host'].lab_root_dir | default('/home/czinda/cert-revocation-lab') }}
              sudo podman exec dogtag-{{ target_ca }}-ca pki -d /root/.dogtag/nssdb -c '' \
                ca-cert-show 0x{{ cert_serial }} 2>/dev/null | grep "Status:" | awk '{print $2}'
          delegate_to: lab-host
          register: verify_status
          tags: [verify]

        - name: Confirm revocation
          ansible.builtin.assert:
            that:
              - verify_status.stdout | trim == 'REVOKED'
            success_msg: "Certificate 0x{{ cert_serial }} successfully revoked"
            fail_msg: "Certificate revocation verification failed - Status: {{ verify_status.stdout | default('unknown') }}"
          tags: [verify]

        - name: Log revocation to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | SERIAL={{ cert_serial }} | CN={{ certificate_cn }} | REASON={{ revocation_reason }} | STATUS=REVOKED"
            create: true
            mode: '0644'
          tags: [logging]

      rescue:
        - name: Log failure details
          ansible.builtin.debug:
            msg: |
              Certificate revocation failed!
              Error: {{ ansible_failed_result.msg | default('Unknown error') }}
              {% if ansible_failed_result.json is defined %}
              API Response: {{ ansible_failed_result.json | to_nice_json }}
              {% endif %}
          tags: [error]

        - name: Log error to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | CN={{ certificate_cn }} | STATUS=FAILED | ERROR={{ ansible_failed_result.msg | default('Unknown') | regex_replace('[\\n\\r]', ' ') }}"
            create: true
            mode: '0644'
          tags: [error, logging]

        - name: Re-raise failure
          ansible.builtin.fail:
            msg: "Certificate revocation failed: {{ ansible_failed_result.msg | default('Unknown error') }}"
          tags: [error]

    - name: Summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - REVOCATION COMPLETE
          ============================================================
          Certificate:  {{ cert_serial | default('N/A') }}
          Subject:      {{ certificate_cn }}
          CA:           {{ target_ca | upper }}
          Status:       REVOKED
          Reason:       {{ revocation_reason }}
          ============================================================
      tags: [always]
