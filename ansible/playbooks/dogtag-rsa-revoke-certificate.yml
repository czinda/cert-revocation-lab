---
# Dogtag RSA-4096 PKI - Certificate Revocation Playbook
# Revokes certificates using the Dogtag REST API (no podman access required)
#
# Expected variables from EDA:
#   event.device_fqdn - Device FQDN whose certificate should be revoked
#   event.certificate_cn - Certificate Common Name (optional)
#   event.certificate_serial - Certificate serial number (hex, e.g. 0x1a2b)
#   event.severity - Event severity (low, medium, high, critical)
#   event.event_id - Unique event identifier
#   event.description - Event description

- name: Revoke Certificate - RSA-4096 PKI (REST API)
  hosts: localhost
  gather_facts: false
  vars:
    # PKI type
    pki_type: "rsa"
    pki_name: "RSA-4096"

    # CA selection (root, intermediate, iot)
    target_ca: "{{ event.ca_level | default(ca_level) | default('iot') }}"

    # Event data (passed from EDA)
    device_fqdn: "{{ event.device_fqdn | default('unknown.cert-lab.local') }}"
    certificate_cn: "{{ event.certificate_cn | default(device_fqdn) }}"
    certificate_serial: "{{ event.certificate_serial | default('') }}"
    event_severity: "{{ event.severity | default('high') }}"
    event_id: "{{ event.event_id | default('manual') }}"
    event_description: "{{ event.description | default('Security incident') }}"

    # Revocation settings
    # CRL reason codes and their string values for Dogtag REST API:
    #   0 = UNSPECIFIED
    #   1 = KEY_COMPROMISE
    #   2 = CA_COMPROMISE
    #   3 = AFFILIATION_CHANGED
    #   4 = SUPERSEDED
    #   5 = CESSATION_OF_OPERATION
    #   6 = CERTIFICATE_HOLD
    #   9 = PRIVILEGE_WITHDRAWN
    revocation_reason_code: "{{ reason | default(1) }}"
    # Map reason codes to Dogtag REST API string values
    reason_map:
      0: "UNSPECIFIED"
      1: "KEY_COMPROMISE"
      2: "CA_COMPROMISE"
      3: "AFFILIATION_CHANGED"
      4: "SUPERSEDED"
      5: "CESSATION_OF_OPERATION"
      6: "CERTIFICATE_HOLD"
      9: "PRIVILEGE_WITHDRAWN"
    revocation_reason: "{{ reason_map[revocation_reason_code | int] | default('KEY_COMPROMISE') }}"
    log_file: "{{ lookup('env', 'LAB_LOG_DIR') | default('/opt/cert-lab/logs', true) }}/dogtag-revocation.log"

    # Certificate paths (mounted from host via compose)
    certs_dir: "/certs"
    admin_creds_dir: "{{ certs_dir }}/admin"

    # RSA PKI configuration - REST API URLs
    # Note: Use external host ports since EDA runs on separate network
    #   Root CA: 8443, Intermediate CA: 8444, IoT CA: 8445
    ca_configs:
      root:
        name: "Root CA"
        url: "https://root-ca.cert-lab.local:8443"
        admin_cert: "{{ admin_creds_dir }}/root-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/root-admin-key.pem"
        ca_cert: "{{ certs_dir }}/root-ca.crt"
      intermediate:
        name: "Intermediate CA"
        url: "https://intermediate-ca.cert-lab.local:8444"
        admin_cert: "{{ admin_creds_dir }}/intermediate-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/intermediate-admin-key.pem"
        ca_cert: "{{ certs_dir }}/ca-chain.crt"
      iot:
        name: "IoT CA"
        url: "https://iot-ca.cert-lab.local:8445"
        admin_cert: "{{ admin_creds_dir }}/iot-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/iot-admin-key.pem"
        ca_cert: "{{ certs_dir }}/iot-ca-chain.crt"

  tasks:
    - name: Set CA configuration
      ansible.builtin.set_fact:
        ca_config: "{{ ca_configs[target_ca] }}"

    - name: Display revocation request
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - CERTIFICATE REVOCATION (REST API)
          ============================================================
          Event ID:      {{ event_id }}
          Device:        {{ device_fqdn }}
          Certificate:   {{ certificate_cn }}
          Serial:        {{ certificate_serial | default('auto-detect') }}
          Severity:      {{ event_severity }}
          Target CA:     {{ target_ca | upper }} ({{ ca_config.name }})
          CA URL:        {{ ca_config.url }}
          Reason:        {{ revocation_reason }}
          Description:   {{ event_description }}
          ============================================================
      tags: [always]

    - name: Validate severity for automatic revocation
      ansible.builtin.assert:
        that:
          - event_severity in ['high', 'critical']
        fail_msg: "Severity '{{ event_severity }}' does not trigger automatic revocation"
      when: not (force_revoke | default(false) | bool)
      tags: [validation]

    - name: Check admin credentials exist
      ansible.builtin.stat:
        path: "{{ ca_config.admin_cert }}"
      register: admin_cert_stat
      tags: [validation]

    - name: Fail if admin credentials missing
      ansible.builtin.fail:
        msg: |
          Admin credentials not found: {{ ca_config.admin_cert }}
          Run the PKI init script to export admin credentials:
            sudo podman exec dogtag-{{ target_ca }}-ca /scripts/init-{{ target_ca }}-ca.sh
      when: not admin_cert_stat.stat.exists
      tags: [validation]

    - name: Block for Dogtag REST API operations
      block:
        - name: Search for certificate by subject (if serial not provided)
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs"
            method: GET
            headers:
              Accept: "application/json"
            url_username: ""
            url_password: ""
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: cert_search
          when: certificate_serial == ''
          tags: [lookup]

        - name: Find matching certificate from search results
          ansible.builtin.set_fact:
            cert_serial: >-
              {{
                cert_search.json.entries
                | selectattr('SubjectDN', 'search', certificate_cn, ignorecase=True)
                | selectattr('Status', 'equalto', 'VALID')
                | map(attribute='id')
                | first
                | default('')
              }}
          when: certificate_serial == '' and cert_search is defined and cert_search.json is defined
          tags: [lookup]

        - name: Use provided certificate serial
          ansible.builtin.set_fact:
            cert_serial: "{{ certificate_serial | regex_replace('^0x', '') }}"
          when: certificate_serial != ''
          tags: [lookup]

        - name: Verify certificate serial found
          ansible.builtin.fail:
            msg: "No valid certificate found for {{ certificate_cn }}"
          when: cert_serial is not defined or cert_serial == ''
          tags: [validation]

        - name: Display certificate to revoke
          ansible.builtin.debug:
            msg: "Found certificate serial: {{ cert_serial }}"
          tags: [lookup]

        - name: Get certificate details before revocation
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs/0x{{ cert_serial }}"
            method: GET
            headers:
              Accept: "application/json"
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: cert_details
          tags: [lookup]

        - name: Display certificate details
          ansible.builtin.debug:
            msg: |
              Certificate Details:
                Serial:    {{ cert_details.json.id | default('N/A') }}
                Subject:   {{ cert_details.json.SubjectDN | default('N/A') }}
                Issuer:    {{ cert_details.json.IssuerDN | default('N/A') }}
                Status:    {{ cert_details.json.Status | default('N/A') }}
                NotBefore: {{ cert_details.json.NotValidBefore | default('N/A') }}
                NotAfter:  {{ cert_details.json.NotValidAfter | default('N/A') }}
          when: cert_details.json is defined
          tags: [lookup]

        - name: Revoke certificate via REST API with session
          ansible.builtin.shell: |
            python3 << 'PYTHON_SCRIPT'
            import http.cookiejar
            import json
            import ssl
            import sys
            import urllib.request
            import urllib.error

            cert = "{{ ca_config.admin_cert }}"
            key = "{{ ca_config.admin_key }}"
            ca_url = "{{ ca_config.url }}"
            serial = "0x{{ cert_serial }}"
            reason = "{{ revocation_reason }}"

            # Create SSL context with client cert
            ctx = ssl.create_default_context()
            ctx.check_hostname = False
            ctx.verify_mode = ssl.CERT_NONE
            ctx.load_cert_chain(certfile=cert, keyfile=key)

            # Create opener with cookie support
            cookie_jar = http.cookiejar.CookieJar()
            cookie_handler = urllib.request.HTTPCookieProcessor(cookie_jar)
            https_handler = urllib.request.HTTPSHandler(context=ctx)
            opener = urllib.request.build_opener(cookie_handler, https_handler)

            # Step 1: Login to establish session
            login_url = f"{ca_url}/ca/rest/account/login"
            req = urllib.request.Request(login_url, method="GET")
            req.add_header("Accept", "application/json")
            try:
                with opener.open(req, timeout=30) as resp:
                    print(f"Login: OK (HTTP {resp.status})")
            except urllib.error.HTTPError as e:
                print(f"Login: HTTP {e.code}")

            # Step 2: Revoke certificate
            revoke_url = f"{ca_url}/ca/rest/agent/certs/{serial}/revoke"
            body = json.dumps({"reason": reason}).encode("utf-8")
            req = urllib.request.Request(revoke_url, data=body, method="POST")
            req.add_header("Accept", "application/json")
            req.add_header("Content-Type", "application/json")

            try:
                with opener.open(req, timeout=30) as resp:
                    print(f"Revocation: OK (HTTP {resp.status})")
                    sys.exit(0)
            except urllib.error.HTTPError as e:
                error_body = e.read().decode("utf-8") if e.fp else ""
                print(f"Revocation failed: HTTP {e.code}")
                print(f"Response: {error_body}")
                sys.exit(1)
            except Exception as e:
                print(f"Error: {e}")
                sys.exit(1)
            PYTHON_SCRIPT
          register: revoke_result
          tags: [revoke]

        - name: Display revocation result
          ansible.builtin.debug:
            msg: "{{ revoke_result.stdout_lines | default(['Revocation command executed']) }}"
          tags: [revoke]

        - name: Wait for revocation to process
          ansible.builtin.pause:
            seconds: 2
          tags: [verify]

        - name: Verify revocation status
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs/0x{{ cert_serial }}"
            method: GET
            headers:
              Accept: "application/json"
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: verify_status
          tags: [verify]

        - name: Confirm revocation
          ansible.builtin.assert:
            that:
              - verify_status.json.Status == 'REVOKED'
            success_msg: "Certificate {{ cert_serial }} successfully revoked"
            fail_msg: "Certificate revocation verification failed - Status: {{ verify_status.json.Status | default('unknown') }}"
          tags: [verify]

        - name: Log revocation to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | SERIAL={{ cert_serial }} | CN={{ certificate_cn }} | REASON={{ revocation_reason }} | STATUS=REVOKED"
            create: true
            mode: '0644'
          tags: [logging]

      rescue:
        - name: Log failure details
          ansible.builtin.debug:
            msg: |
              Certificate revocation failed!
              Error: {{ ansible_failed_result.msg | default('Unknown error') }}
              {% if ansible_failed_result.json is defined %}
              API Response: {{ ansible_failed_result.json | to_nice_json }}
              {% endif %}
          tags: [error]

        - name: Log error to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | CN={{ certificate_cn }} | STATUS=FAILED | ERROR={{ ansible_failed_result.msg | default('Unknown') | regex_replace('[\\n\\r]', ' ') }}"
            create: true
            mode: '0644'
          tags: [error, logging]

        - name: Re-raise failure
          ansible.builtin.fail:
            msg: "Certificate revocation failed: {{ ansible_failed_result.msg | default('Unknown error') }}"
          tags: [error]

    - name: Summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - REVOCATION COMPLETE
          ============================================================
          Certificate:  {{ cert_serial | default('N/A') }}
          Subject:      {{ certificate_cn }}
          CA:           {{ target_ca | upper }}
          Status:       REVOKED
          Reason:       {{ revocation_reason }}
          ============================================================
      tags: [always]
