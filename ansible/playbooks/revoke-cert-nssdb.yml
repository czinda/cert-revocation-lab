---
# Certificate Revocation using REST API with admin credentials
#
# Usage:
#   ansible-playbook revoke-cert-nssdb.yml -e cert_serial=0x123abc
#   ansible-playbook revoke-cert-nssdb.yml -e cert_serial=0x123abc -e pki=ecc -e ca=iot
#
# Prerequisites:
#   Run scripts/export-all-admin-creds.sh to export admin certificates

- name: Revoke Certificate (REST API)
  hosts: localhost
  gather_facts: false
  vars:
    # Optional: PKI type (rsa, ecc, pqc)
    pki_type: "{{ pki | default('rsa') }}"

    # Optional: CA level (root, intermediate, iot)
    ca_level: "{{ ca | default('iot') }}"

    # Revocation reason
    revoke_reason: "{{ reason | default('KEY_COMPROMISE') }}"

    # Certs directory
    certs_base: "{{ playbook_dir }}/../../data/certs"

    # CA port mappings
    ca_ports:
      rsa:
        root: 8443
        intermediate: 8444
        iot: 8445
      ecc:
        root: 8463
        intermediate: 8464
        iot: 8465
      pqc:
        root: 8453
        intermediate: 8454
        iot: 8455

  tasks:
    - name: Validate cert_serial provided
      ansible.builtin.fail:
        msg: "Serial number required. Usage: -e cert_serial=0x123abc"
      when: cert_serial is not defined or cert_serial == ''

    - name: Set paths based on PKI type
      ansible.builtin.set_fact:
        serial_clean: "{{ cert_serial | regex_replace('^0x', '') }}"
        ca_port: "{{ ca_ports[pki_type][ca_level] }}"
        admin_cert: "{{ certs_base }}/admin/{{ ca_level }}-admin-cert.pem"
        admin_key: "{{ certs_base }}/admin/{{ ca_level }}-admin-key.pem"
      when: pki_type == 'rsa'

    - name: Set paths for ECC PKI
      ansible.builtin.set_fact:
        serial_clean: "{{ cert_serial | regex_replace('^0x', '') }}"
        ca_port: "{{ ca_ports[pki_type][ca_level] }}"
        admin_cert: "{{ certs_base }}/ecc/admin/ecc-{{ ca_level }}-admin-cert.pem"
        admin_key: "{{ certs_base }}/ecc/admin/ecc-{{ ca_level }}-admin-key.pem"
      when: pki_type == 'ecc'

    - name: Set paths for PQC PKI
      ansible.builtin.set_fact:
        serial_clean: "{{ cert_serial | regex_replace('^0x', '') }}"
        ca_port: "{{ ca_ports[pki_type][ca_level] }}"
        admin_cert: "{{ certs_base }}/pq/admin/pq-{{ ca_level }}-admin-cert.pem"
        admin_key: "{{ certs_base }}/pq/admin/pq-{{ ca_level }}-admin-key.pem"
      when: pki_type == 'pqc'

    - name: Check admin cert exists
      ansible.builtin.stat:
        path: "{{ admin_cert }}"
      register: cert_check

    - name: Fail if admin cert missing
      ansible.builtin.fail:
        msg: |
          Admin cert not found: {{ admin_cert }}
          Run: ./scripts/export-all-admin-creds.sh
      when: not cert_check.stat.exists

    - name: Show operation details
      ansible.builtin.debug:
        msg: |
          Revoking certificate:
            Serial:     {{ serial_clean }}
            PKI:        {{ pki_type | upper }}
            CA:         {{ ca_level }}
            Port:       {{ ca_port }}
            Admin Cert: {{ admin_cert }}
            Reason:     {{ revoke_reason }}

    - name: Get certificate status before revocation
      ansible.builtin.uri:
        url: "https://localhost:{{ ca_port }}/ca/rest/certs/{{ serial_clean }}"
        method: GET
        headers:
          Accept: "application/json"
        client_cert: "{{ admin_cert }}"
        client_key: "{{ admin_key }}"
        validate_certs: false
        return_content: true
      register: before_status
      ignore_errors: true

    - name: Show current status
      ansible.builtin.debug:
        msg: "Current status: {{ before_status.json.Status | default('UNKNOWN') }}"
      when: before_status.json is defined

    - name: Revoke the certificate
      ansible.builtin.uri:
        url: "https://localhost:{{ ca_port }}/ca/rest/agent/certs/{{ serial_clean }}/revoke"
        method: POST
        headers:
          Accept: "application/json"
          Content-Type: "application/json"
        body_format: json
        body:
          reason: "{{ revoke_reason }}"
        client_cert: "{{ admin_cert }}"
        client_key: "{{ admin_key }}"
        validate_certs: false
        return_content: true
        status_code: [200, 204]
      register: revoke_result

    - name: Wait for revocation to process
      ansible.builtin.pause:
        seconds: 2

    - name: Verify revocation status
      ansible.builtin.uri:
        url: "https://localhost:{{ ca_port }}/ca/rest/certs/{{ serial_clean }}"
        method: GET
        headers:
          Accept: "application/json"
        client_cert: "{{ admin_cert }}"
        client_key: "{{ admin_key }}"
        validate_certs: false
        return_content: true
      register: after_status

    - name: Confirm revoked
      ansible.builtin.assert:
        that:
          - after_status.json.Status == 'REVOKED'
        success_msg: "Certificate {{ serial_clean }} successfully REVOKED"
        fail_msg: "Revocation failed - status is {{ after_status.json.Status }}"

    - name: Final status
      ansible.builtin.debug:
        msg: |
          ========================================
          REVOCATION COMPLETE
          ========================================
          Serial: {{ serial_clean }}
          Status: REVOKED
          ========================================
