---
# Dogtag ML-DSA-87 PKI - Certificate Revocation Playbook
# Revokes certificates using the Dogtag REST API (no podman access required)
#
# Expected variables from EDA:
#   event.device_fqdn - Device FQDN whose certificate should be revoked
#   event.certificate_cn - Certificate Common Name (optional)
#   event.certificate_serial - Certificate serial number (hex, e.g. 0x1a2b)
#   event.severity - Event severity (low, medium, high, critical)
#   event.event_id - Unique event identifier
#   event.description - Event description

- name: Revoke Certificate - ML-DSA-87 PKI (REST API)
  hosts: localhost
  gather_facts: false
  vars:
    # PKI type
    pki_type: "pqc"
    pki_name: "ML-DSA-87"

    # CA selection (root, intermediate, iot)
    target_ca: "{{ event.ca_level | default(ca_level) | default('iot') }}"

    # Event data (passed from EDA)
    device_fqdn: "{{ event.device_fqdn | default('unknown.cert-lab.local') }}"
    certificate_cn: "{{ event.certificate_cn | default(device_fqdn) }}"
    certificate_serial: "{{ event.certificate_serial | default('') }}"
    event_severity: "{{ event.severity | default('high') }}"
    event_id: "{{ event.event_id | default('manual') }}"
    event_description: "{{ event.description | default('Security incident') }}"

    # Revocation settings
    # CRL reason codes and their string values for Dogtag REST API:
    #   0 = UNSPECIFIED
    #   1 = KEY_COMPROMISE
    #   2 = CA_COMPROMISE
    #   3 = AFFILIATION_CHANGED
    #   4 = SUPERSEDED
    #   5 = CESSATION_OF_OPERATION
    #   6 = CERTIFICATE_HOLD
    #   9 = PRIVILEGE_WITHDRAWN
    revocation_reason_code: "{{ reason | default(1) }}"
    # Map reason codes to Dogtag REST API string values
    reason_map:
      0: "UNSPECIFIED"
      1: "KEY_COMPROMISE"
      2: "CA_COMPROMISE"
      3: "AFFILIATION_CHANGED"
      4: "SUPERSEDED"
      5: "CESSATION_OF_OPERATION"
      6: "CERTIFICATE_HOLD"
      9: "PRIVILEGE_WITHDRAWN"
    revocation_reason: "{{ reason_map[revocation_reason_code | int] | default('KEY_COMPROMISE') }}"
    log_file: "{{ lookup('env', 'LAB_LOG_DIR') | default('/opt/cert-lab/logs', true) }}/dogtag-revocation.log"

    # Certificate paths (mounted from host via compose)
    # PQC certs are in /certs/pq/ since PQC containers mount ./data/certs/pq:/certs
    # but EDA mounts ./data/certs:/certs - so PQC admin creds are at /certs/pq/admin/
    certs_dir: "/certs"
    admin_creds_dir: "{{ certs_dir }}/pq/admin"

    # PQC PKI configuration - REST API URLs
    # Note: Use external host ports since EDA runs on separate network
    #   PQ Root CA: 8453, Intermediate CA: 8454, IoT CA: 8455
    ca_configs:
      root:
        name: "PQ Root CA"
        url: "https://pq-root-ca.cert-lab.local:8453"
        admin_cert: "{{ admin_creds_dir }}/pq-root-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/pq-root-admin-key.pem"
        ca_cert: "{{ certs_dir }}/pq/root-ca.crt"
      intermediate:
        name: "PQ Intermediate CA"
        url: "https://pq-intermediate-ca.cert-lab.local:8454"
        admin_cert: "{{ admin_creds_dir }}/pq-intermediate-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/pq-intermediate-admin-key.pem"
        ca_cert: "{{ certs_dir }}/pq/ca-chain.crt"
      iot:
        name: "PQ IoT CA"
        url: "https://pq-iot-ca.cert-lab.local:8455"
        admin_cert: "{{ admin_creds_dir }}/pq-iot-admin-cert.pem"
        admin_key: "{{ admin_creds_dir }}/pq-iot-admin-key.pem"
        ca_cert: "{{ certs_dir }}/pq/iot-ca-chain.crt"

  tasks:
    - name: Set CA configuration
      ansible.builtin.set_fact:
        ca_config: "{{ ca_configs[target_ca] }}"

    - name: Display revocation request
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - CERTIFICATE REVOCATION (REST API)
          ============================================================
          Event ID:      {{ event_id }}
          Device:        {{ device_fqdn }}
          Certificate:   {{ certificate_cn }}
          Serial:        {{ certificate_serial | default('auto-detect') }}
          Severity:      {{ event_severity }}
          Target CA:     {{ target_ca | upper }} ({{ ca_config.name }})
          CA URL:        {{ ca_config.url }}
          Reason:        {{ revocation_reason }}
          Description:   {{ event_description }}
          ============================================================
      tags: [always]

    - name: Validate severity for automatic revocation
      ansible.builtin.assert:
        that:
          - event_severity in ['high', 'critical']
        fail_msg: "Severity '{{ event_severity }}' does not trigger automatic revocation"
      when: not (force_revoke | default(false) | bool)
      tags: [validation]

    - name: Check admin credentials exist
      ansible.builtin.stat:
        path: "{{ ca_config.admin_cert }}"
      register: admin_cert_stat
      tags: [validation]

    - name: Fail if admin credentials missing
      ansible.builtin.fail:
        msg: |
          Admin credentials not found: {{ ca_config.admin_cert }}
          Run the PKI init script to export admin credentials:
            sudo podman exec dogtag-pq-{{ target_ca }}-ca /scripts/export-admin-creds.sh {{ target_ca }}
      when: not admin_cert_stat.stat.exists
      tags: [validation]

    - name: Block for Dogtag REST API operations
      block:
        - name: Search for certificate by subject (if serial not provided)
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs"
            method: GET
            headers:
              Accept: "application/json"
            url_username: ""
            url_password: ""
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: cert_search
          when: certificate_serial == ''
          tags: [lookup]

        - name: Find matching certificate from search results
          ansible.builtin.set_fact:
            cert_serial: >-
              {{
                cert_search.json.entries
                | selectattr('SubjectDN', 'search', certificate_cn, ignorecase=True)
                | selectattr('Status', 'equalto', 'VALID')
                | map(attribute='id')
                | first
                | default('')
              }}
          when: certificate_serial == '' and cert_search is defined and cert_search.json is defined
          tags: [lookup]

        - name: Use provided certificate serial
          ansible.builtin.set_fact:
            cert_serial: "{{ certificate_serial | regex_replace('^0x', '') }}"
          when: certificate_serial != ''
          tags: [lookup]

        - name: Verify certificate serial found
          ansible.builtin.fail:
            msg: "No valid certificate found for {{ certificate_cn }}"
          when: cert_serial is not defined or cert_serial == ''
          tags: [validation]

        - name: Display certificate to revoke
          ansible.builtin.debug:
            msg: "Found certificate serial: {{ cert_serial }}"
          tags: [lookup]

        - name: Get certificate details before revocation
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs/0x{{ cert_serial }}"
            method: GET
            headers:
              Accept: "application/json"
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: cert_details
          tags: [lookup]

        - name: Display certificate details
          ansible.builtin.debug:
            msg: |
              Certificate Details:
                Serial:    {{ cert_details.json.id | default('N/A') }}
                Subject:   {{ cert_details.json.SubjectDN | default('N/A') }}
                Issuer:    {{ cert_details.json.IssuerDN | default('N/A') }}
                Status:    {{ cert_details.json.Status | default('N/A') }}
                NotBefore: {{ cert_details.json.NotValidBefore | default('N/A') }}
                NotAfter:  {{ cert_details.json.NotValidAfter | default('N/A') }}
          when: cert_details.json is defined
          tags: [lookup]

        - name: Revoke certificate via pki CLI
          ansible.builtin.shell: |
            podman exec dogtag-pq-{{ target_ca }}-ca bash -c '
            set -e
            CLIENT_DB=/root/.dogtag/nssdb
            CA_URL=https://localhost:8443

            # Find admin cert nickname
            ADMIN_NICK=$(certutil -L -d $CLIENT_DB 2>/dev/null | grep -i admin | head -1 | awk "{for(i=1;i<=NF-1;i++) printf \$i\" \"; print \"\"}" | sed "s/ *$//")
            if [ -z "$ADMIN_NICK" ]; then
                echo "ERROR: Admin certificate not found in NSS database"
                exit 1
            fi

            echo "Using admin cert: $ADMIN_NICK"

            # Revoke the certificate
            pki -d $CLIENT_DB -c "" -n "$ADMIN_NICK" -U "$CA_URL" \
                --ignore-cert-status UNTRUSTED_ISSUER --ignore-cert-status UNKNOWN_ISSUER \
                ca-cert-revoke 0x{{ cert_serial }} --reason Key_Compromise --force
            '
          register: revoke_result
          become: true
          tags: [revoke]

        - name: Display revocation result
          ansible.builtin.debug:
            msg: "{{ revoke_result.stdout_lines | default(['Revocation command executed']) }}"
          tags: [revoke]

        - name: Wait for revocation to process
          ansible.builtin.pause:
            seconds: 2
          tags: [verify]

        - name: Verify revocation status
          ansible.builtin.uri:
            url: "{{ ca_config.url }}/ca/rest/certs/0x{{ cert_serial }}"
            method: GET
            headers:
              Accept: "application/json"
            client_cert: "{{ ca_config.admin_cert }}"
            client_key: "{{ ca_config.admin_key }}"
            validate_certs: false
            return_content: true
            status_code: [200]
          register: verify_status
          tags: [verify]

        - name: Confirm revocation
          ansible.builtin.assert:
            that:
              - verify_status.json.Status == 'REVOKED'
            success_msg: "Certificate {{ cert_serial }} successfully revoked"
            fail_msg: "Certificate revocation verification failed - Status: {{ verify_status.json.Status | default('unknown') }}"
          tags: [verify]

        - name: Log revocation to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | SERIAL={{ cert_serial }} | CN={{ certificate_cn }} | REASON={{ revocation_reason }} | STATUS=REVOKED"
            create: true
            mode: '0644'
          tags: [logging]

      rescue:
        - name: Log failure details
          ansible.builtin.debug:
            msg: |
              Certificate revocation failed!
              Error: {{ ansible_failed_result.msg | default('Unknown error') }}
              {% if ansible_failed_result.json is defined %}
              API Response: {{ ansible_failed_result.json | to_nice_json }}
              {% endif %}
          tags: [error]

        - name: Log error to file
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "{{ lookup('pipe', 'date -Iseconds') }} | PKI={{ pki_name }} | CA={{ target_ca }} | EVENT={{ event_id }} | CN={{ certificate_cn }} | STATUS=FAILED | ERROR={{ ansible_failed_result.msg | default('Unknown') | regex_replace('[\\n\\r]', ' ') }}"
            create: true
            mode: '0644'
          tags: [error, logging]

        - name: Re-raise failure
          ansible.builtin.fail:
            msg: "Certificate revocation failed: {{ ansible_failed_result.msg | default('Unknown error') }}"
          tags: [error]

    - name: Summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          DOGTAG {{ pki_name }} - REVOCATION COMPLETE
          ============================================================
          Certificate:  {{ cert_serial | default('N/A') }}
          Subject:      {{ certificate_cn }}
          CA:           {{ target_ca | upper }}
          Status:       REVOKED
          Reason:       {{ revocation_reason }}
          ============================================================
      tags: [always]
